<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Almoxarifado EPI - Sistema Profissional</title>
    <meta name="theme-color" content="#0F172A">
    <meta name="color-scheme" content="dark">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suprime warning do Tailwind CDN
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Work+Sans:wght@300;400;600;700;800&display=swap');
        
        /* Reset e força tema escuro */
        html, body {
            margin: 0;
            padding: 0;
            background-color: #0f172a !important;
            color: #f1f5f9 !important;
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        body { 
            overscroll-behavior-y: none;
            font-family: 'Work Sans', sans-serif;
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #0f172a !important;
            color: #f1f5f9 !important;
        }
        
        #app {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
        }
        
        .font-mono { font-family: 'Space Mono', monospace; }
        
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide-in { animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        
        /* Skeleton Loading */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        /* Optimistic UI */
        .optimistic-update {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .success-flash {
            animation: successFlash 0.5s ease-out;
        }
        
        @keyframes successFlash {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(16, 185, 129, 0.2); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Gradient Background */
        .bg-gradient-dark {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%) !important;
        }
        
        /* Força tema escuro em todos os elementos */
        html {
            background: #0f172a !important;
        }
        
        * {
            scrollbar-color: #475569 #1e293b;
        }
        
        /* Garante tema escuro em inputs e selects */
        input, select, textarea {
            color-scheme: dark;
        }
        
        input::placeholder, textarea::placeholder {
            color: #94a3b8;
        }
        
        /* Glass Effect */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Status Badge Animation */
        .status-badge {
            position: relative;
            overflow: hidden;
        }
        
        .status-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .status-badge:hover::before {
            left: 100%;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideInRight 0.3s ease-out;
            max-width: 90%;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast-success { background: #10b981; color: white; }
        .toast-error { background: #ef4444; color: white; }
        .toast-info { background: #3b82f6; color: white; }
        
        /* Pull to Refresh Indicator */
        .ptr-indicator {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            padding: 10px 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            border-radius: 0 0 12px 12px;
            font-weight: bold;
            transition: transform 0.3s;
            z-index: 1000;
        }
        
        .ptr-indicator.active {
            transform: translateX(-50%) translateY(0);
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* Mobile optimizations */
        @media (max-width: 640px) {
            .toast {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: calc(100% - 20px);
            }
            
            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body class="text-gray-100">
    <div id="app"></div>
    <div id="toast-container"></div>

    <script>
        // ============================================
        // CONFIGURAÇÃO
        // ============================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyncVvza7PTzk4E6nM8uSAWrAmHfVvT5GXWxleFnoXr6uSdqx6S0qPEV8z7jV3Wj_mpvw/exec';
        
        // Cache otimizado
        const cache = {
            movements: null,
            movementsTimestamp: null,
            movementsFilterKey: null,
            items: null,
            itemsTimestamp: null,
            statistics: null,
            statisticsTimestamp: null,
            CACHE_DURATION: 300000 // 5 minutos
        };

        // ============================================
        // TIPOS DE MOVIMENTAÇÃO
        // ============================================
        const MOVEMENT_TYPES = {
            'COMPRA': { label: 'Compra de Estoque', color: 'emerald', icon: 'shopping-cart', sign: '+' },
            'REPOSICAO': { label: 'Reposição', color: 'blue', icon: 'arrow-clockwise', sign: '-' },
            'DISTRIBUICAO': { label: 'Distribuição EPI', color: 'purple', icon: 'hand-coins', sign: '-' },
            'SAIDA': { label: 'Saída', color: 'red', icon: 'arrow-up-right', sign: '-' },
            'AJUSTE': { label: 'Ajuste', color: 'amber', icon: 'wrench', sign: '±' }
        };

        // ============================================
        // ESTADO DA APLICAÇÃO
        // ============================================
        let state = {
            view: 'login',
            previousView: null,
            user: null,
            items: [],
            movements: [],
            selectedDate: getCurrentDate(),
            isLoading: false,
            loadingMessage: '',
            
            // Paginação
            currentPage: 1,
            itemsPerPage: 50,
            
            // Filtros avançados
            filters: {
                startDate: getFirstDayOfMonth(),
                endDate: getCurrentDate(),
                type: 'TODOS',
                searchTerm: '',
                category: 'TODAS',
                minQuantity: '',
                maxQuantity: '',
                location: '',
                lowStockOnly: false
            },
            
            // Operação de movimentação
            movementOperation: {
                active: false,
                type: null,
                selectedItem: null,
                employeeName: '',
                supplier: '',
                quantity: 1,
                observations: ''
            },
            
            // Edição de item
            editingItem: null,
            
            // Estatísticas e Analytics
            statistics: null,
            analytics: {
                weeklyExpenses: [],
                monthlyExpenses: [],
                topReplenishedItems: [],
                categoryDistribution: []
            }
        };

        // Navigation history para o botão voltar
        let navigationHistory = [];

        // Debounce timer
        let searchDebounceTimer = null;

        // Pull to refresh
        let touchStartY = 0;
        let pullDistance = 0;
        const PULL_THRESHOLD = 80;

        // ============================================
        // UTILITÁRIOS
        // ============================================
        function getCurrentDate() {
            return new Date().toISOString().split('T')[0];
        }

        function getFirstDayOfMonth() {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                let date;
                if (dateStr instanceof Date) {
                    date = dateStr;
                } else if (typeof dateStr === 'string') {
                    if (dateStr.includes('-') && dateStr.length === 10) {
                        date = new Date(dateStr + 'T12:00:00');
                    } else {
                        date = new Date(dateStr);
                    }
                } else {
                    date = new Date(dateStr);
                }
                
                return date.toLocaleDateString('pt-BR', { 
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                console.error('Erro ao formatar data:', dateStr, e);
                return dateStr;
            }
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                console.error('Erro ao formatar data/hora:', dateStr, e);
                return dateStr;
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function getColorClass(color, type = 'bg') {
            const colors = {
                emerald: type === 'bg' ? 'bg-emerald-500/20 border-emerald-500 text-emerald-400' : 'bg-emerald-600',
                red: type === 'bg' ? 'bg-red-500/20 border-red-500 text-red-400' : 'bg-red-600',
                blue: type === 'bg' ? 'bg-blue-500/20 border-blue-500 text-blue-400' : 'bg-blue-600',
                purple: type === 'bg' ? 'bg-purple-500/20 border-purple-500 text-purple-400' : 'bg-purple-600',
                amber: type === 'bg' ? 'bg-amber-500/20 border-amber-500 text-amber-400' : 'bg-amber-600',
                slate: type === 'bg' ? 'bg-slate-500/20 border-slate-500 text-slate-400' : 'bg-slate-600'
            };
            return colors[color] || colors.slate;
        }

        function debounce(func, wait) {
            return function executedFunction(...args) {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => func(...args), wait);
            };
        }

        function isCacheValid(timestamp) {
            if (!timestamp) return false;
            return (Date.now() - timestamp) < cache.CACHE_DURATION;
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="ph-fill ph-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info'} text-2xl"></i>
                    <span class="font-semibold">${message}</span>
                </div>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => container.removeChild(toast), 300);
            }, duration);
        }

        // ============================================
        // NAVEGAÇÃO E HISTÓRICO
        // ============================================
        function navigateTo(view) {
            if (state.view !== view) {
                navigationHistory.push(state.view);
                state.previousView = state.view;
                state.view = view;
                render();
            }
        }

        function goBack() {
            if (navigationHistory.length > 0) {
                const previousView = navigationHistory.pop();
                state.view = previousView;
                render();
                return true;
            }
            return false;
        }

        // Intercepta o botão voltar do navegador/dispositivo
        document.addEventListener('keydown', (e) => {
            // ESC para voltar
            if (e.key === 'Escape' && state.view !== 'login') {
                e.preventDefault();
                if (state.view === 'dashboard') {
                    if (confirm('Deseja sair do sistema?')) {
                        handleLogout();
                    }
                } else {
                    if (!goBack()) {
                        navigateTo('dashboard');
                    }
                }
            }
        });

        // Logout automático ao fechar a aba/navegador
        window.addEventListener('beforeunload', (e) => {
            // Salva estado antes de sair
            if (state.user) {
                // Mantém a sessão salva para próxima vez
                // Se quiser deslogar, descomente a linha abaixo:
                // clearSession();
            }
        });

        // Logout automático ao sair da página (navegar para outro site)
        window.addEventListener('pagehide', (e) => {
            // Desloga ao sair da página
            clearSession();
        });

        // ============================================
        // PERSISTÊNCIA DE LOGIN (7 DIAS)
        // ============================================
        function saveSession(user) {
            const session = {
                user: user,
                timestamp: Date.now(),
                expiresIn: 7 * 24 * 60 * 60 * 1000 // 7 dias
            };
            localStorage.setItem('epi_session', JSON.stringify(session));
        }

        function loadSession() {
            const sessionData = localStorage.getItem('epi_session');
            if (!sessionData) return null;
            
            try {
                const session = JSON.parse(sessionData);
                const now = Date.now();
                
                // Verifica se a sessão ainda é válida
                if (session.timestamp + session.expiresIn > now) {
                    return session.user;
                } else {
                    localStorage.removeItem('epi_session');
                    return null;
                }
            } catch (e) {
                localStorage.removeItem('epi_session');
                return null;
            }
        }

        function clearSession() {
            localStorage.removeItem('epi_session');
        }

        // ============================================
        // SERVIÇOS / API COM OPTIMISTIC UI
        // ============================================
        async function login(username, password) {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro no login:', error);
                return { success: false, error: error.message };
            }
        }

        async function getItems(forceRefresh = false) {
            if (!forceRefresh && cache.items && isCacheValid(cache.itemsTimestamp)) {
                return { success: true, items: cache.items };
            }

            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getItems`);
                const data = await response.json();
                
                if (data.success) {
                    cache.items = data.items;
                    cache.itemsTimestamp = Date.now();
                }
                
                return data;
            } catch (error) {
                console.error('Erro ao buscar itens:', error);
                return { success: false, error: error.message };
            }
        }

        async function saveItem(item) {
            // Optimistic UI - atualiza a interface imediatamente
            const isNew = !state.items.find(i => i.id === item.id);
            
            if (isNew) {
                state.items.push(item);
            } else {
                const index = state.items.findIndex(i => i.id === item.id);
                state.items[index] = item;
            }
            
            render();
            showToast(isNew ? 'Item cadastrado!' : 'Item atualizado!', 'success', 2000);
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'saveItem', item: item })
                });
                const data = await response.json();
                
                if (data.success) {
                    cache.items = null;
                    cache.itemsTimestamp = null;
                    // Recarrega em background para garantir sincronização
                    loadItems(true);
                } else {
                    // Reverte em caso de erro
                    if (isNew) {
                        state.items = state.items.filter(i => i.id !== item.id);
                    } else {
                        loadItems(true);
                    }
                    showToast('Erro ao salvar item', 'error');
                }
                
                return data;
            } catch (error) {
                console.error('Erro ao salvar item:', error);
                // Reverte em caso de erro
                loadItems(true);
                showToast('Erro ao salvar item', 'error');
                return { success: false, error: error.message };
            }
        }

        async function deleteItem(itemId) {
            // Optimistic UI
            const itemBackup = state.items.find(i => i.id === itemId);
            state.items = state.items.filter(i => i.id !== itemId);
            render();
            showToast('Item excluído!', 'success', 2000);
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'deleteItem', itemId: itemId })
                });
                const data = await response.json();
                
                if (data.success) {
                    cache.items = null;
                    cache.itemsTimestamp = null;
                } else {
                    // Reverte em caso de erro
                    state.items.push(itemBackup);
                    render();
                    showToast('Erro ao excluir item', 'error');
                }
                
                return data;
            } catch (error) {
                console.error('Erro ao deletar item:', error);
                // Reverte em caso de erro
                state.items.push(itemBackup);
                render();
                showToast('Erro ao excluir item', 'error');
                return { success: false, error: error.message };
            }
        }

        async function saveMovement(movement) {
            // Optimistic UI - atualiza estoque imediatamente
            const item = state.items.find(i => i.id === movement.itemId);
            if (item) {
                const oldQuantity = item.quantidade;
                
                // Atualiza quantidade baseado no tipo
                if (movement.type === 'COMPRA') {
                    item.quantidade += movement.quantity;
                } else if (['DISTRIBUICAO', 'SAIDA', 'REPOSICAO'].includes(movement.type)) {
                    item.quantidade -= movement.quantity;
                } else if (movement.type === 'AJUSTE') {
                    item.quantidade = movement.quantity;
                }
                
                render();
                showToast('Movimentação registrada!', 'success', 2000);
                
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'saveMovement', movement: movement })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        cache.movements = null;
                        cache.movementsTimestamp = null;
                        cache.items = null;
                        cache.itemsTimestamp = null;
                        cache.statistics = null;
                        cache.statisticsTimestamp = null;
                        // Recarrega em background
                        loadItems(true);
                    } else {
                        // Reverte em caso de erro
                        item.quantidade = oldQuantity;
                        render();
                        showToast('Erro ao registrar movimentação', 'error');
                    }
                    
                    return data;
                } catch (error) {
                    console.error('Erro ao salvar movimentação:', error);
                    // Reverte em caso de erro
                    item.quantidade = oldQuantity;
                    render();
                    showToast('Erro ao registrar movimentação', 'error');
                    return { success: false, error: error.message };
                }
            }
        }

        async function getMovements(filters, forceRefresh = false) {
            const filterKey = JSON.stringify(filters);
            if (!forceRefresh && cache.movements && cache.movementsFilterKey === filterKey && isCacheValid(cache.movementsTimestamp)) {
                return { success: true, movements: cache.movements };
            }

            try {
                const params = new URLSearchParams({
                    action: 'getMovements',
                    startDate: filters.startDate,
                    endDate: filters.endDate,
                    type: filters.type
                });
                
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    cache.movements = data.movements;
                    cache.movementsFilterKey = filterKey;
                    cache.movementsTimestamp = Date.now();
                }
                
                return data;
            } catch (error) {
                console.error('Erro ao buscar movimentações:', error);
                return { success: false, error: error.message };
            }
        }

        async function getStatistics() {
            if (cache.statistics && isCacheValid(cache.statisticsTimestamp)) {
                return { success: true, statistics: cache.statistics };
            }

            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getStatistics`);
                const data = await response.json();
                
                if (data.success) {
                    cache.statistics = data.statistics;
                    cache.statisticsTimestamp = Date.now();
                }
                
                return data;
            } catch (error) {
                console.error('Erro ao buscar estatísticas:', error);
                return { success: false, error: error.message };
            }
        }

        // ============================================
        // LÓGICA DE NEGÓCIO
        // ============================================
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showToast('Preencha todos os campos', 'error');
                return;
            }

            state.isLoading = true;
            state.loadingMessage = 'Autenticando...';
            render();

            const result = await login(username, password);

            if (result.success) {
                state.user = result.user;
                saveSession(result.user);
                
                state.loadingMessage = 'Carregando dados...';
                render();
                
                await loadItems();
                navigateTo('dashboard');
                showToast(`Bem-vindo, ${result.user.nome}!`, 'success');
            } else {
                showToast('Login falhou: ' + (result.error || 'Credenciais inválidas'), 'error');
            }

            state.isLoading = false;
            state.loadingMessage = '';
            render();
        }

        async function loadItems(forceRefresh = false) {
            const result = await getItems(forceRefresh);
            if (result.success) {
                state.items = result.items;
            }
        }

        async function loadMovements(forceRefresh = false) {
            const result = await getMovements(state.filters, forceRefresh);
            if (result.success) {
                state.movements = result.movements;
                state.currentPage = 1;
            }
        }

        async function loadStatistics() {
            const result = await getStatistics();
            if (result.success) {
                state.statistics = result.statistics;
                calculateAnalytics();
            }
        }

        function calculateAnalytics() {
            // Calcula analytics baseado nas movimentações
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            // Movimentações recentes
            const recentMovements = state.movements.filter(m => {
                const movDate = new Date(m.date);
                return movDate >= monthAgo;
            });
            
            // Itens mais repostos
            const replenishmentCount = {};
            recentMovements.forEach(m => {
                if (m.type === 'REPOSICAO' || m.type === 'COMPRA') {
                    replenishmentCount[m.itemName] = (replenishmentCount[m.itemName] || 0) + m.quantity;
                }
            });
            
            state.analytics.topReplenishedItems = Object.entries(replenishmentCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([name, count]) => ({ name, count }));
            
            // Distribuição por categoria
            const categoryDist = {};
            state.items.forEach(item => {
                categoryDist[item.categoria] = (categoryDist[item.categoria] || 0) + item.quantidade;
            });
            
            state.analytics.categoryDistribution = Object.entries(categoryDist)
                .map(([category, quantity]) => ({ category, quantity }));
        }

        function handleLogout() {
            clearSession();
            state.user = null;
            state.items = [];
            state.movements = [];
            cache.items = null;
            cache.movements = null;
            cache.itemsTimestamp = null;
            cache.movementsTimestamp = null;
            cache.statistics = null;
            cache.statisticsTimestamp = null;
            navigationHistory = [];
            navigateTo('login');
            showToast('Sessão encerrada', 'info');
        }

        // Funções de movimentação
        function openMovementSelector() {
            navigateTo('movementSelector');
        }

        function startMovement(type) {
            state.movementOperation = {
                active: true,
                type: type,
                selectedItem: null,
                employeeName: '',
                supplier: '',
                quantity: 1,
                observations: ''
            };
            navigateTo('movement');
        }

        function cancelMovement() {
            state.movementOperation = {
                active: false,
                type: null,
                selectedItem: null,
                employeeName: '',
                supplier: '',
                quantity: 1,
                observations: ''
            };
            goBack();
        }

        async function confirmMovement() {
            const op = state.movementOperation;
            
            if (!op.selectedItem || op.quantity <= 0) {
                showToast('Preencha todos os campos obrigatórios', 'error');
                return;
            }

            if (op.type === 'DISTRIBUICAO' && !op.employeeName) {
                showToast('Nome do colaborador é obrigatório', 'error');
                return;
            }

            if (op.type === 'COMPRA' && !op.supplier) {
                showToast('Nome do fornecedor é obrigatório', 'error');
                return;
            }

            const item = state.items.find(i => i.id === op.selectedItem);
            if (!item) {
                showToast('Item não encontrado', 'error');
                return;
            }

            if (['DISTRIBUICAO', 'SAIDA', 'REPOSICAO'].includes(op.type) && item.quantidade < op.quantity) {
                showToast('Quantidade em estoque insuficiente', 'error');
                return;
            }

            const movement = {
                date: getCurrentDate(),
                type: op.type,
                itemId: item.id,
                itemName: item.nome,
                quantity: op.quantity,
                employee: op.employeeName || '',
                supplier: op.supplier || '',
                user: state.user.nome,
                observations: op.observations
            };

            const result = await saveMovement(movement);

            if (result.success) {
                cancelMovement();
            }
        }

        async function handleSaveItem(e) {
            e.preventDefault();
            
            const itemData = {
                id: state.editingItem?.id || 'ITEM-' + Date.now(),
                nome: document.getElementById('itemName').value,
                categoria: document.getElementById('itemCategory').value,
                quantidade: parseInt(document.getElementById('itemQuantity').value),
                unidade: document.getElementById('itemUnit').value,
                ca: document.getElementById('itemCA').value,
                validade: document.getElementById('itemValidity').value,
                localizacao: document.getElementById('itemLocation').value,
                observacoes: document.getElementById('itemObs').value
            };

            const result = await saveItem(itemData);

            if (result.success) {
                state.editingItem = null;
                goBack();
            }
        }

        async function handleDeleteItem(itemId) {
            if (!confirm('Tem certeza que deseja excluir este item?')) {
                return;
            }

            await deleteItem(itemId);
        }

        function openEditItem(item) {
            state.editingItem = item;
            navigateTo('editItem');
        }

        function openNewItem() {
            state.editingItem = null;
            navigateTo('editItem');
        }

        async function applyFilters() {
            state.isLoading = true;
            state.loadingMessage = 'Buscando movimentações...';
            render();
            
            await loadMovements(true);
            
            state.isLoading = false;
            state.loadingMessage = '';
            render();
        }

        async function navigateToHistory() {
            navigateTo('history');
            state.isLoading = true;
            state.loadingMessage = 'Carregando histórico...';
            render();
            
            await loadMovements(true);
            
            state.isLoading = false;
            state.loadingMessage = '';
            render();
        }

        async function navigateToDashboardAnalytics() {
            navigateTo('analytics');
            state.isLoading = true;
            state.loadingMessage = 'Carregando analytics...';
            render();
            
            await loadStatistics();
            await loadMovements(true);
            
            state.isLoading = false;
            state.loadingMessage = '';
            render();
            
            // Renderiza gráficos após um pequeno delay para garantir que o DOM está pronto
            setTimeout(() => renderCharts(), 100);
        }

        function changePage(delta) {
            const totalPages = Math.ceil(getFilteredMovements().length / state.itemsPerPage);
            const newPage = state.currentPage + delta;
            
            if (newPage >= 1 && newPage <= totalPages) {
                state.currentPage = newPage;
                render();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function getFilteredMovements() {
            let filtered = state.movements;
            
            if (state.filters.searchTerm) {
                const term = state.filters.searchTerm.toLowerCase();
                filtered = filtered.filter(m => 
                    m.itemName?.toLowerCase().includes(term) ||
                    m.employee?.toLowerCase().includes(term) ||
                    m.supplier?.toLowerCase().includes(term) ||
                    m.user?.toLowerCase().includes(term)
                );
            }
            
            return filtered;
        }

        function getPaginatedMovements() {
            const filtered = getFilteredMovements();
            const start = (state.currentPage - 1) * state.itemsPerPage;
            const end = start + state.itemsPerPage;
            return filtered.slice(start, end);
        }

        function getFilteredItems() {
            let filtered = state.items;
            
            // Filtro por categoria
            if (state.filters.category !== 'TODAS') {
                filtered = filtered.filter(i => i.categoria === state.filters.category);
            }
            
            // Filtro por localização
            if (state.filters.location) {
                const loc = state.filters.location.toLowerCase();
                filtered = filtered.filter(i => i.localizacao?.toLowerCase().includes(loc));
            }
            
            // Filtro por quantidade mínima
            if (state.filters.minQuantity !== '') {
                filtered = filtered.filter(i => i.quantidade >= parseInt(state.filters.minQuantity));
            }
            
            // Filtro por quantidade máxima
            if (state.filters.maxQuantity !== '') {
                filtered = filtered.filter(i => i.quantidade <= parseInt(state.filters.maxQuantity));
            }
            
            // Filtro por estoque baixo
            if (state.filters.lowStockOnly) {
                filtered = filtered.filter(i => i.quantidade < 10);
            }
            
            // Filtro por busca de texto
            if (state.filters.searchTerm) {
                const term = state.filters.searchTerm.toLowerCase();
                filtered = filtered.filter(i => 
                    i.nome?.toLowerCase().includes(term) ||
                    i.categoria?.toLowerCase().includes(term) ||
                    i.localizacao?.toLowerCase().includes(term) ||
                    i.ca?.toLowerCase().includes(term)
                );
            }
            
            return filtered;
        }

        const handleSearchInput = debounce((value) => {
            state.filters.searchTerm = value;
            state.currentPage = 1;
            render();
        }, 300);

        // ============================================
        // GRÁFICOS COM CHART.JS
        // ============================================
        let chartsInstances = {};

        function renderCharts() {
            // Destroi gráficos anteriores
            Object.values(chartsInstances).forEach(chart => chart.destroy());
            chartsInstances = {};
            
            // Gráfico de distribuição por categoria
            renderCategoryChart();
            
            // Gráfico de top itens mais repostos
            renderTopItemsChart();
            
            // Gráfico de movimentações por tipo
            renderMovementsTypeChart();
        }

        function renderCategoryChart() {
            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;
            
            const labels = state.analytics.categoryDistribution.map(c => c.category);
            const data = state.analytics.categoryDistribution.map(c => c.quantity);
            
            chartsInstances.categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(251, 146, 60, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)',
                            'rgb(59, 130, 246)',
                            'rgb(139, 92, 246)',
                            'rgb(251, 146, 60)',
                            'rgb(239, 68, 68)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'rgb(203, 213, 225)',
                                font: {
                                    family: 'Work Sans'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Distribuição por Categoria',
                            color: 'rgb(203, 213, 225)',
                            font: {
                                size: 16,
                                family: 'Work Sans',
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        }

        function renderTopItemsChart() {
            const ctx = document.getElementById('topItemsChart');
            if (!ctx) return;
            
            const labels = state.analytics.topReplenishedItems.map(i => i.name.substring(0, 20));
            const data = state.analytics.topReplenishedItems.map(i => i.count);
            
            chartsInstances.topItemsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade Reposta',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Top 5 Itens Mais Repostos',
                            color: 'rgb(203, 213, 225)',
                            font: {
                                size: 16,
                                family: 'Work Sans',
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'rgb(148, 163, 184)'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'rgb(148, 163, 184)'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function renderMovementsTypeChart() {
            const ctx = document.getElementById('movementsTypeChart');
            if (!ctx || !state.statistics) return;
            
            const movTypes = state.statistics.movementsByType;
            const labels = Object.keys(movTypes).map(type => MOVEMENT_TYPES[type]?.label || type);
            const data = Object.values(movTypes);
            
            chartsInstances.movementsTypeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(251, 146, 60, 0.8)'
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)',
                            'rgb(59, 130, 246)',
                            'rgb(139, 92, 246)',
                            'rgb(239, 68, 68)',
                            'rgb(251, 146, 60)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'rgb(203, 213, 225)',
                                font: {
                                    family: 'Work Sans'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Movimentações por Tipo',
                            color: 'rgb(203, 213, 225)',
                            font: {
                                size: 16,
                                family: 'Work Sans',
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // RENDERIZAÇÃO
        // ============================================
        function render() {
            const app = document.getElementById('app');
            
            switch(state.view) {
                case 'login':
                    app.innerHTML = renderLogin();
                    break;
                case 'dashboard':
                    app.innerHTML = renderDashboard();
                    break;
                case 'analytics':
                    app.innerHTML = renderAnalytics();
                    break;
                case 'stock':
                    app.innerHTML = renderStock();
                    break;
                case 'movementSelector':
                    app.innerHTML = renderMovementSelector();
                    break;
                case 'movement':
                    app.innerHTML = renderMovement();
                    break;
                case 'history':
                    app.innerHTML = renderHistory();
                    break;
                case 'editItem':
                    app.innerHTML = renderEditItem();
                    break;
            }
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex flex-col justify-center items-center p-6">
                    <div class="glass p-8 rounded-2xl w-full max-w-md shadow-2xl fade-in">
                        <div class="flex justify-center mb-6 text-emerald-400">
                            <i class="ph-fill ph-package text-7xl"></i>
                        </div>
                        <h1 class="text-4xl font-bold text-center mb-2 font-mono">ALMOXARIFADO</h1>
                        <p class="text-center text-slate-400 mb-8 text-sm uppercase tracking-wider">Sistema de Controle de EPIs</p>
                        
                        <form onsubmit="handleLogin(event)" class="space-y-6">
                            <div>
                                <label class="text-sm font-bold text-slate-300 block mb-2 uppercase tracking-wide">Usuário</label>
                                <div class="relative">
                                    <i class="ph ph-user absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                                    <input 
                                        type="text" 
                                        id="username"
                                        class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 pl-12 focus:border-emerald-500 outline-none text-lg text-white"
                                        placeholder="Digite seu usuário"
                                        ${state.isLoading ? 'disabled' : ''}
                                        required
                                    >
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-sm font-bold text-slate-300 block mb-2 uppercase tracking-wide">Senha</label>
                                <div class="relative">
                                    <i class="ph ph-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                                    <input 
                                        type="password" 
                                        id="password"
                                        class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 pl-12 focus:border-emerald-500 outline-none text-lg text-white"
                                        placeholder="Digite sua senha"
                                        ${state.isLoading ? 'disabled' : ''}
                                        required
                                    >
                                </div>
                            </div>
                            
                            <button 
                                type="submit" 
                                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 uppercase tracking-wider disabled:opacity-50 disabled:cursor-not-allowed"
                                ${state.isLoading ? 'disabled' : ''}
                            >
                                ${state.isLoading ? `<i class="ph ph-spinner animate-spin text-2xl"></i> ${state.loadingMessage.toUpperCase()}` : '<i class="ph ph-sign-in text-xl"></i> ENTRAR'}
                            </button>
                        </form>
                        
                        <div class="mt-6 text-center text-xs text-slate-500 font-mono">
                            <p>v3.0.0 | © 2026</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const totalItems = state.items.length;
            const totalQuantity = state.items.reduce((sum, item) => sum + item.quantidade, 0);
            const lowStock = state.items.filter(item => item.quantidade < 10).length;

            return `
                <div class="min-h-screen pb-6">
                    ${renderHeader()}
                    
                    <main class="p-4 max-w-7xl mx-auto space-y-6">
                        <!-- Statistics Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 fade-in">
                            <div class="glass p-6 rounded-xl border-l-4 border-emerald-500">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-slate-400 text-sm uppercase tracking-wide font-semibold">Total de Itens</p>
                                        <p class="text-4xl font-bold font-mono mt-2">${totalItems}</p>
                                    </div>
                                    <div class="w-16 h-16 bg-emerald-500/20 rounded-xl flex items-center justify-center">
                                        <i class="ph-fill ph-package text-emerald-400 text-3xl"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="glass p-6 rounded-xl border-l-4 border-blue-500">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-slate-400 text-sm uppercase tracking-wide font-semibold">Quantidade Total</p>
                                        <p class="text-4xl font-bold font-mono mt-2">${totalQuantity}</p>
                                    </div>
                                    <div class="w-16 h-16 bg-blue-500/20 rounded-xl flex items-center justify-center">
                                        <i class="ph-fill ph-stack text-blue-400 text-3xl"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="glass p-6 rounded-xl border-l-4 border-amber-500">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-slate-400 text-sm uppercase tracking-wide font-semibold">Estoque Baixo</p>
                                        <p class="text-4xl font-bold font-mono mt-2">${lowStock}</p>
                                    </div>
                                    <div class="w-16 h-16 bg-amber-500/20 rounded-xl flex items-center justify-center">
                                        <i class="ph-fill ph-warning text-amber-400 text-3xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="glass p-6 rounded-xl slide-in">
                            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                                <i class="ph-fill ph-lightning text-amber-400"></i>
                                Ações Rápidas
                            </h2>
                            <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
                                <button onclick="openMovementSelector()" class="glass p-6 rounded-lg hover:border-emerald-500 border-2 border-transparent transition-all text-center group">
                                    <div class="w-12 h-12 bg-emerald-500/20 rounded-lg flex items-center justify-center mb-3 group-hover:scale-110 transition-transform mx-auto">
                                        <i class="ph-fill ph-arrows-clockwise text-emerald-400 text-2xl"></i>
                                    </div>
                                    <h3 class="font-bold text-sm mb-1">Movimentações</h3>
                                    <p class="text-slate-400 text-xs">Registrar</p>
                                </button>

                                <button onclick="navigateTo('stock')" class="glass p-6 rounded-lg hover:border-blue-500 border-2 border-transparent transition-all text-center group">
                                    <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center mb-3 group-hover:scale-110 transition-transform mx-auto">
                                        <i class="ph-fill ph-warehouse text-blue-400 text-2xl"></i>
                                    </div>
                                    <h3 class="font-bold text-sm mb-1">Estoque</h3>
                                    <p class="text-slate-400 text-xs">Visualizar</p>
                                </button>

                                <button onclick="navigateToHistory()" class="glass p-6 rounded-lg hover:border-purple-500 border-2 border-transparent transition-all text-center group">
                                    <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center mb-3 group-hover:scale-110 transition-transform mx-auto">
                                        <i class="ph-fill ph-clock-counter-clockwise text-purple-400 text-2xl"></i>
                                    </div>
                                    <h3 class="font-bold text-sm mb-1">Histórico</h3>
                                    <p class="text-slate-400 text-xs">Ver</p>
                                </button>

                                <button onclick="navigateToDashboardAnalytics()" class="glass p-6 rounded-lg hover:border-pink-500 border-2 border-transparent transition-all text-center group">
                                    <div class="w-12 h-12 bg-pink-500/20 rounded-lg flex items-center justify-center mb-3 group-hover:scale-110 transition-transform mx-auto">
                                        <i class="ph-fill ph-chart-line text-pink-400 text-2xl"></i>
                                    </div>
                                    <h3 class="font-bold text-sm mb-1">Analytics</h3>
                                    <p class="text-slate-400 text-xs">Relatórios</p>
                                </button>

                                <button onclick="openNewItem()" class="glass p-6 rounded-lg hover:border-amber-500 border-2 border-transparent transition-all text-center group">
                                    <div class="w-12 h-12 bg-amber-500/20 rounded-lg flex items-center justify-center mb-3 group-hover:scale-110 transition-transform mx-auto">
                                        <i class="ph-fill ph-plus-circle text-amber-400 text-2xl"></i>
                                    </div>
                                    <h3 class="font-bold text-sm mb-1">Novo Item</h3>
                                    <p class="text-slate-400 text-xs">Cadastrar</p>
                                </button>
                            </div>
                        </div>

                        <!-- Recent Items -->
                        <div class="glass p-6 rounded-xl">
                            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                                <i class="ph-fill ph-list text-blue-400"></i>
                                Itens Recentes
                            </h2>
                            ${state.items.length === 0 ? `
                                <div class="text-center py-12 text-slate-500">
                                    <i class="ph ph-package text-6xl mb-4 opacity-50"></i>
                                    <p>Nenhum item cadastrado</p>
                                </div>
                            ` : `
                                <div class="space-y-2">
                                    ${state.items.slice(0, 5).map(item => `
                                        <div class="glass p-4 rounded-lg flex items-center justify-between hover:border-slate-600 border-2 border-transparent transition-all">
                                            <div class="flex-1">
                                                <h3 class="font-bold text-lg">${item.nome}</h3>
                                                <div class="flex gap-2 mt-1">
                                                    <span class="text-xs px-2 py-1 bg-blue-500/20 text-blue-400 rounded-full font-semibold">${item.categoria}</span>
                                                    <span class="text-xs px-2 py-1 bg-slate-500/20 text-slate-400 rounded-full font-mono">${item.unidade}</span>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-2xl font-bold font-mono ${item.quantidade < 10 ? 'text-amber-400' : 'text-emerald-400'}">${item.quantidade}</p>
                                                <p class="text-xs text-slate-500 uppercase">Em estoque</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </main>
                </div>
            `;
        }

        function renderAnalytics() {
            return `
                <div class="min-h-screen pb-6">
                    ${renderHeader()}
                    
                    <main class="p-4 max-w-7xl mx-auto space-y-6">
                        <h1 class="text-3xl font-bold flex items-center gap-3 fade-in">
                            <i class="ph-fill ph-chart-line text-pink-400"></i>
                            Analytics e Relatórios
                        </h1>

                        ${state.isLoading ? `
                            <div class="glass p-12 rounded-xl text-center">
                                <i class="ph ph-spinner animate-spin text-6xl text-blue-400 mb-4"></i>
                                <p class="text-slate-400">${state.loadingMessage}</p>
                            </div>
                        ` : `
                            <!-- Gráficos -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="glass p-6 rounded-xl slide-in">
                                    <div class="chart-container">
                                        <canvas id="categoryChart"></canvas>
                                    </div>
                                </div>

                                <div class="glass p-6 rounded-xl slide-in">
                                    <div class="chart-container">
                                        <canvas id="movementsTypeChart"></canvas>
                                    </div>
                                </div>

                                <div class="glass p-6 rounded-xl slide-in lg:col-span-2">
                                    <div class="chart-container">
                                        <canvas id="topItemsChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Estatísticas Detalhadas -->
                            ${state.statistics ? `
                                <div class="glass p-6 rounded-xl">
                                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                                        <i class="ph-fill ph-chart-bar text-blue-400"></i>
                                        Estatísticas Detalhadas
                                    </h2>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div class="text-center p-4 bg-emerald-500/10 rounded-lg">
                                            <p class="text-emerald-400 text-3xl font-bold font-mono">${state.statistics.totalMovements}</p>
                                            <p class="text-slate-400 text-sm mt-1">Total Movimentações</p>
                                        </div>
                                        <div class="text-center p-4 bg-blue-500/10 rounded-lg">
                                            <p class="text-blue-400 text-3xl font-bold font-mono">${state.statistics.movementsByType.COMPRA || 0}</p>
                                            <p class="text-slate-400 text-sm mt-1">Compras</p>
                                        </div>
                                        <div class="text-center p-4 bg-purple-500/10 rounded-lg">
                                            <p class="text-purple-400 text-3xl font-bold font-mono">${state.statistics.movementsByType.DISTRIBUICAO || 0}</p>
                                            <p class="text-slate-400 text-sm mt-1">Distribuições</p>
                                        </div>
                                        <div class="text-center p-4 bg-amber-500/10 rounded-lg">
                                            <p class="text-amber-400 text-3xl font-bold font-mono">${state.statistics.lowStock}</p>
                                            <p class="text-slate-400 text-sm mt-1">Estoque Baixo</p>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        `}
                    </main>
                </div>
            `;
        }

        function renderMovementSelector() {
            return `
                <div class="min-h-screen pb-6">
                    ${renderHeader()}
                    
                    <main class="p-4 max-w-5xl mx-auto">
                        <div class="glass p-8 rounded-xl">
                            <div class="flex items-center justify-between mb-6">
                                <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                                    <i class="ph-fill ph-arrows-clockwise text-emerald-400"></i>
                                    Tipo de Movimentação
                                </h1>
                                <button onclick="goBack()" class="text-slate-400 hover:text-white transition-all">
                                    <i class="ph ph-x text-3xl"></i>
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mt-8">
                                <!-- Compra de Estoque -->
                                <button onclick="startMovement('COMPRA')" class="glass p-6 md:p-8 rounded-xl hover:border-emerald-500 border-2 border-transparent transition-all group text-center">
                                    <div class="w-12 h-12 md:w-16 md:h-16 bg-emerald-500/20 rounded-xl flex items-center justify-center mb-3 md:mb-4 group-hover:scale-110 transition-transform mx-auto">
                                        <i class="ph-fill ph-shopping-cart text-emerald-400 text-3xl md:text-4xl"></i>
                                    </div>
                                    <h3 class="font-bold text-lg md:text-xl mb-2">Compra</h3>
                                    <p class="text-slate-400 text-xs md:text-sm">Novos itens do fornecedor</p>
                                    <div class="mt-3 md:mt-4 pt-3 md:pt-4 border-t border-slate-700">
                                        <p class="text-xs text-emerald-400 font-semibold">
                                            <i class="ph-fill ph-arrow-up"></i> ADICIONA
                                        </p>
                                    </div>
                                </button>

                                <!-- Reposição -->
                                <button onclick="startMovement('REPOSICAO')" class="glass p-6 md:p-8 rounded-xl hover:border-blue-500 border-2 border-transparent transition-all group text-center">
                                    <div class="w-12 h-12 md:w-16 md:h-16 bg-blue-500/20 rounded-xl flex items-center justify-center mb-3 md:mb-4 group-hover:scale-110 transition-transform mx-auto">
                                        <i class="ph-fill ph-arrow-clockwise text-blue-400 text-3xl md:text-4xl"></i>
                                    </div>
                                    <h3 class="font-bold text-lg md:text-xl mb-2">Reposição</h3>
                                    <p class="text-slate-400 text-xs md:text-sm">Transferência interna</p>
                                    <div class="mt-3 md:mt-4 pt-3 md:pt-4 border-t border-slate-700">
                                        <p class="text-xs text-blue-400 font-semibold">
                                            <i class="ph-fill ph-arrow-down"></i> REMOVE
                                        </p>
                                    </div>
                                </button>

                                <!-- Distribuição -->
                                <button onclick="startMovement('DISTRIBUICAO')" class="glass p-6 md:p-8 rounded-xl hover:border-purple-500 border-2 border-transparent transition-all group text-center">
                                    <div class="w-12 h-12 md:w-16 md:h-16 bg-purple-500/20 rounded-xl flex items-center justify-center mb-3 md:mb-4 group-hover:scale-110 transition-transform mx-auto">
                                        <i class="ph-fill ph-hand-coins text-purple-400 text-3xl md:text-4xl"></i>
                                    </div>
                                    <h3 class="font-bold text-lg md:text-xl mb-2">Distribuição</h3>
                                    <p class="text-slate-400 text-xs md:text-sm">Entrega para colaborador</p>
                                    <div class="mt-3 md:mt-4 pt-3 md:pt-4 border-t border-slate-700">
                                        <p class="text-xs text-purple-400 font-semibold">
                                            <i class="ph-fill ph-arrow-down"></i> REMOVE
                                        </p>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function renderMovement() {
            const op = state.movementOperation;
            const typeInfo = MOVEMENT_TYPES[op.type];
            const availableItems = ['DISTRIBUICAO', 'REPOSICAO'].includes(op.type) ? state.items.filter(item => item.quantidade > 0) : state.items;
            const selectedItem = availableItems.find(item => item.id === op.selectedItem);

            return `
                <div class="min-h-screen pb-6">
                    ${renderHeader()}
                    
                    <main class="p-4 max-w-3xl mx-auto">
                        <div class="glass p-6 md:p-8 rounded-xl">
                            <div class="flex items-center justify-between mb-6">
                                <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                                    <i class="ph-fill ph-${typeInfo.icon} text-${typeInfo.color}-400"></i>
                                    <span class="hidden md:inline">${typeInfo.label}</span>
                                    <span class="md:hidden">${typeInfo.label.split(' ')[0]}</span>
                                </h1>
                                <button onclick="cancelMovement()" class="text-slate-400 hover:text-white transition-all">
                                    <i class="ph ph-x text-3xl"></i>
                                </button>
                            </div>

                            ${availableItems.length === 0 ? `
                                <div class="text-center py-12 text-slate-500">
                                    <i class="ph ph-warning-circle text-6xl md:text-8xl mb-4 text-amber-500"></i>
                                    <p class="text-lg md:text-xl mb-4">Nenhum item disponível</p>
                                    <button onclick="cancelMovement()" class="bg-slate-700 hover:bg-slate-600 px-6 py-3 rounded-lg font-bold">
                                        Voltar
                                    </button>
                                </div>
                            ` : `
                                <form onsubmit="event.preventDefault(); confirmMovement();" class="space-y-6">
                                    <div>
                                        <label class="text-sm font-bold text-slate-300 block mb-3 uppercase tracking-wide">Selecione o Item *</label>
                                        <select 
                                            onchange="state.movementOperation.selectedItem = this.value; render()"
                                            class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 focus:border-${typeInfo.color}-500 outline-none text-base md:text-lg text-white"
                                            required
                                        >
                                            <option value="">-- Escolha um item --</option>
                                            ${availableItems.map(item => `
                                                <option value="${item.id}" ${op.selectedItem === item.id ? 'selected' : ''}>
                                                    ${item.nome} (${item.quantidade})
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>

                                    ${selectedItem ? `
                                        <div class="glass p-4 rounded-lg border-2 border-${typeInfo.color}-500/50">
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <p class="text-slate-400 text-sm">Selecionado</p>
                                                    <p class="font-bold text-base md:text-lg">${selectedItem.nome}</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-slate-400 text-sm">Estoque</p>
                                                    <p class="font-bold text-xl md:text-2xl font-mono text-${typeInfo.color}-400">${selectedItem.quantidade}</p>
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${op.type === 'DISTRIBUICAO' ? `
                                        <div>
                                            <label class="text-sm font-bold text-slate-300 block mb-3 uppercase tracking-wide">Colaborador *</label>
                                            <input 
                                                type="text"
                                                value="${op.employeeName}"
                                                onchange="state.movementOperation.employeeName = this.value"
                                                class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 focus:border-${typeInfo.color}-500 outline-none text-base md:text-lg text-white"
                                                placeholder="Nome completo"
                                                required
                                            >
                                        </div>
                                    ` : ''}

                                    ${op.type === 'COMPRA' ? `
                                        <div>
                                            <label class="text-sm font-bold text-slate-300 block mb-3 uppercase tracking-wide">Fornecedor *</label>
                                            <input 
                                                type="text"
                                                value="${op.supplier}"
                                                onchange="state.movementOperation.supplier = this.value"
                                                class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 focus:border-${typeInfo.color}-500 outline-none text-base md:text-lg text-white"
                                                placeholder="Nome do fornecedor"
                                                required
                                            >
                                        </div>
                                    ` : ''}

                                    <div>
                                        <label class="text-sm font-bold text-slate-300 block mb-3 uppercase tracking-wide">Quantidade *</label>
                                        <input 
                                            type="number"
                                            value="${op.quantity}"
                                            onchange="state.movementOperation.quantity = parseInt(this.value)"
                                            min="1"
                                            ${selectedItem && (op.type === 'DISTRIBUICAO' || op.type === 'REPOSICAO') ? `max="${selectedItem.quantidade}"` : ''}
                                            class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 focus:border-${typeInfo.color}-500 outline-none text-base md:text-lg text-white font-mono"
                                            required
                                        >
                                    </div>

                                    <div>
                                        <label class="text-sm font-bold text-slate-300 block mb-3 uppercase tracking-wide">Observações</label>
                                        <textarea 
                                            onchange="state.movementOperation.observations = this.value"
                                            class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 focus:border-${typeInfo.color}-500 outline-none text-base md:text-lg text-white"
                                            rows="3"
                                            placeholder="Informações adicionais (opcional)"
                                        >${op.observations}</textarea>
                                    </div>

                                    <div class="flex gap-4 pt-6">
                                        <button 
                                            type="button"
                                            onclick="cancelMovement()"
                                            class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 rounded-xl transition-all"
                                        >
                                            CANCELAR
                                        </button>
                                        <button 
                                            type="submit"
                                            class="flex-1 bg-${typeInfo.color}-600 hover:bg-${typeInfo.color}-700 text-white font-bold py-4 rounded-xl transition-all flex items-center justify-center gap-2"
                                        >
                                            <i class="ph ph-check-circle text-xl"></i>
                                            <span class="hidden md:inline">CONFIRMAR</span>
                                            <span class="md:hidden">OK</span>
                                        </button>
                                    </div>
                                </form>
                            `}
                        </div>
                    </main>
                </div>
            `;
        }

        function renderStock() {
            const filteredItems = getFilteredItems();
            const categories = [...new Set(state.items.map(i => i.categoria))];
            
            return `
                <div class="min-h-screen pb-6">
                    ${renderHeader()}
                    
                    <main class="p-4 max-w-7xl mx-auto space-y-6">
                        <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                            <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                                <i class="ph-fill ph-warehouse text-emerald-400"></i>
                                Estoque de EPIs
                            </h1>
                            <button onclick="openNewItem()" class="bg-emerald-600 hover:bg-emerald-700 px-4 md:px-6 py-3 rounded-lg font-bold flex items-center gap-2 transition-all">
                                <i class="ph-fill ph-plus-circle text-xl"></i>
                                <span class="hidden md:inline">Novo Item</span>
                                <span class="md:inline hidden">+</span>
                            </button>
                        </div>

                        <!-- Filtros Avançados -->
                        <div class="glass p-4 md:p-6 rounded-xl">
                            <h2 class="font-bold mb-4 flex items-center gap-2 text-base md:text-lg">
                                <i class="ph ph-funnel text-blue-400"></i>
                                Filtros Avançados
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Categoria</label>
                                    <select 
                                        onchange="state.filters.category = this.value; render()"
                                        class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-3 focus:border-blue-500 outline-none text-white text-sm"
                                    >
                                        <option value="TODAS">Todas</option>
                                        ${categories.map(cat => `
                                            <option value="${cat}" ${state.filters.category === cat ? 'selected' : ''}>${cat}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Localização</label>
                                    <input 
                                        type="text"
                                        value="${state.filters.location}"
                                        oninput="state.filters.location = this.value; render()"
                                        class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-3 focus:border-blue-500 outline-none text-white text-sm"
                                        placeholder="Ex: Prateleira A1"
                                    >
                                </div>
                                <div class="flex items-end">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input 
                                            type="checkbox"
                                            ${state.filters.lowStockOnly ? 'checked' : ''}
                                            onchange="state.filters.lowStockOnly = this.checked; render()"
                                            class="w-5 h-5 rounded"
                                        >
                                        <span class="text-sm font-semibold text-amber-400">Apenas Estoque Baixo</span>
                                    </label>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Pesquisar</label>
                                <input 
                                    type="text"
                                    value="${state.filters.searchTerm}"
                                    oninput="handleSearchInput(this.value)"
                                    class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-3 focus:border-blue-500 outline-none text-white"
                                    placeholder="Buscar por nome, categoria, CA..."
                                >
                            </div>
                        </div>

                        ${filteredItems.length === 0 ? `
                            <div class="glass p-12 rounded-xl text-center">
                                <i class="ph ph-package text-6xl md:text-8xl text-slate-600 mb-4"></i>
                                <p class="text-slate-400 text-lg md:text-xl mb-6">Nenhum item encontrado</p>
                                ${state.filters.searchTerm || state.filters.category !== 'TODAS' || state.filters.location || state.filters.lowStockOnly ? `
                                    <button onclick="state.filters = {startDate: getFirstDayOfMonth(), endDate: getCurrentDate(), type: 'TODOS', searchTerm: '', category: 'TODAS', minQuantity: '', maxQuantity: '', location: '', lowStockOnly: false}; render()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-bold">
                                        Limpar Filtros
                                    </button>
                                ` : `
                                    <button onclick="openNewItem()" class="bg-emerald-600 hover:bg-emerald-700 px-6 py-3 rounded-lg font-bold">
                                        Cadastrar Primeiro Item
                                    </button>
                                `}
                            </div>
                        ` : `
                            <div class="mb-4 text-slate-400 text-sm">
                                Mostrando <span class="font-bold text-white">${filteredItems.length}</span> de <span class="font-bold text-white">${state.items.length}</span> itens
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${filteredItems.map(item => `
                                    <div class="glass p-4 md:p-6 rounded-xl hover:border-emerald-500 border-2 border-transparent transition-all fade-in">
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="flex-1 pr-2">
                                                <h3 class="font-bold text-lg md:text-xl mb-2 break-words">${item.nome}</h3>
                                                <div class="flex gap-2 flex-wrap">
                                                    <span class="text-xs px-2 md:px-3 py-1 bg-blue-500/20 text-blue-400 rounded-full font-semibold">${item.categoria}</span>
                                                    <span class="text-xs px-2 md:px-3 py-1 bg-slate-500/20 text-slate-400 rounded-full font-mono">${item.unidade}</span>
                                                    ${item.ca ? `<span class="text-xs px-2 md:px-3 py-1 bg-purple-500/20 text-purple-400 rounded-full font-mono">CA ${item.ca}</span>` : ''}
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <div class="flex justify-between items-end mb-2">
                                                <span class="text-slate-400 text-xs md:text-sm uppercase">Quantidade</span>
                                                <span class="text-2xl md:text-3xl font-bold font-mono ${item.quantidade < 10 ? 'text-amber-400' : 'text-emerald-400'}">${item.quantidade}</span>
                                            </div>
                                            ${item.quantidade < 10 ? `
                                                <div class="bg-amber-500/20 border border-amber-500 text-amber-400 px-3 py-2 rounded-lg text-xs font-semibold flex items-center gap-2">
                                                    <i class="ph-fill ph-warning"></i>
                                                    ESTOQUE BAIXO
                                                </div>
                                            ` : ''}
                                        </div>

                                        ${item.localizacao ? `
                                            <p class="text-slate-400 text-xs md:text-sm mb-2 flex items-center gap-2">
                                                <i class="ph ph-map-pin"></i>
                                                ${item.localizacao}
                                            </p>
                                        ` : ''}

                                        ${item.validade ? `
                                            <p class="text-slate-400 text-xs md:text-sm mb-4 flex items-center gap-2">
                                                <i class="ph ph-calendar"></i>
                                                Val: ${formatDate(item.validade)}
                                            </p>
                                        ` : ''}

                                        <div class="flex gap-2 pt-4 border-t border-slate-700">
                                            <button onclick='openEditItem(${JSON.stringify(item).replace(/'/g, "&#39;")})' class="flex-1 bg-blue-600 hover:bg-blue-700 px-3 md:px-4 py-2 rounded-lg font-semibold transition-all flex items-center justify-center gap-2 text-sm">
                                                <i class="ph ph-pencil-simple"></i>
                                                Editar
                                            </button>
                                            <button onclick="handleDeleteItem('${item.id}')" class="bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white px-3 md:px-4 py-2 rounded-lg font-semibold transition-all flex items-center justify-center gap-2 border border-red-500 text-sm">
                                                <i class="ph ph-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </main>
                </div>
            `;
        }

        function renderHistory() {
            const filteredMovements = getFilteredMovements();
            const paginatedMovements = getPaginatedMovements();
            const totalPages = Math.ceil(filteredMovements.length / state.itemsPerPage);

            return `
                <div class="min-h-screen pb-6">
                    ${renderHeader()}
                    
                    <main class="p-4 max-w-7xl mx-auto space-y-6">
                        <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                            <i class="ph-fill ph-clock-counter-clockwise text-purple-400"></i>
                            Histórico de Movimentações
                        </h1>

                        <!-- Filtros -->
                        <div class="glass p-4 md:p-6 rounded-xl">
                            <h2 class="font-bold mb-4 flex items-center gap-2 text-base md:text-lg">
                                <i class="ph ph-funnel text-blue-400"></i>
                                Filtros
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Data Inicial</label>
                                    <input 
                                        type="date"
                                        value="${state.filters.startDate}"
                                        onchange="state.filters.startDate = this.value"
                                        class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-3 focus:border-blue-500 outline-none text-white text-sm"
                                    >
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Data Final</label>
                                    <input 
                                        type="date"
                                        value="${state.filters.endDate}"
                                        onchange="state.filters.endDate = this.value"
                                        class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-3 focus:border-blue-500 outline-none text-white text-sm"
                                    >
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Tipo</label>
                                    <select 
                                        onchange="state.filters.type = this.value"
                                        class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-3 focus:border-blue-500 outline-none text-white text-sm"
                                    >
                                        <option value="TODOS" ${state.filters.type === 'TODOS' ? 'selected' : ''}>Todos</option>
                                        ${Object.entries(MOVEMENT_TYPES).map(([code, info]) => `
                                            <option value="${code}" ${state.filters.type === code ? 'selected' : ''}>${info.label}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button 
                                        onclick="applyFilters()"
                                        class="w-full bg-blue-600 hover:bg-blue-700 px-4 md:px-6 py-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2"
                                        ${state.isLoading ? 'disabled' : ''}
                                    >
                                        <i class="ph ph-magnifying-glass"></i>
                                        BUSCAR
                                    </button>
                                </div>
                            </div>

                            <div class="mt-4">
                                <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Pesquisar</label>
                                <input 
                                    type="text"
                                    value="${state.filters.searchTerm}"
                                    oninput="handleSearchInput(this.value)"
                                    class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-3 focus:border-blue-500 outline-none text-white"
                                    placeholder="Buscar por item, colaborador, fornecedor..."
                                >
                            </div>
                        </div>

                        <!-- Resultados -->
                        <div class="glass p-4 md:p-6 rounded-xl">
                            <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                                <p class="text-slate-400 text-sm">
                                    Mostrando <span class="font-bold text-white">${paginatedMovements.length}</span> de <span class="font-bold text-white">${filteredMovements.length}</span>
                                </p>
                                ${totalPages > 0 ? `
                                    <p class="text-slate-400 font-mono text-xs md:text-sm">
                                        Pág ${state.currentPage}/${totalPages}
                                    </p>
                                ` : ''}
                            </div>

                            ${state.isLoading ? `
                                <div class="text-center py-12">
                                    <i class="ph ph-spinner animate-spin text-6xl text-blue-400"></i>
                                    <p class="text-slate-400 mt-4">${state.loadingMessage}</p>
                                </div>
                            ` : filteredMovements.length === 0 ? `
                                <div class="text-center py-12 text-slate-500">
                                    <i class="ph ph-database text-6xl md:text-8xl mb-4 opacity-50"></i>
                                    <p class="text-lg md:text-xl">Nenhuma movimentação encontrada</p>
                                    <p class="text-xs md:text-sm mt-2">Ajuste os filtros ou registre uma movimentação</p>
                                </div>
                            ` : `
                                <div class="space-y-2">
                                    ${paginatedMovements.map(movement => {
                                        const typeInfo = MOVEMENT_TYPES[movement.type] || MOVEMENT_TYPES['AJUSTE'];
                                        return `
                                            <div class="glass p-4 rounded-lg hover:border-${typeInfo.color}-500 border-2 border-transparent transition-all">
                                                <div class="flex items-start justify-between gap-4 flex-wrap md:flex-nowrap">
                                                    <div class="flex-1 min-w-0">
                                                        <div class="flex items-center gap-3 mb-2 flex-wrap">
                                                            <div class="w-10 h-10 ${getColorClass(typeInfo.color, 'full')} rounded-lg flex items-center justify-center flex-shrink-0">
                                                                <i class="ph-fill ph-${typeInfo.icon} text-white text-xl"></i>
                                                            </div>
                                                            <div class="min-w-0 flex-1">
                                                                <h3 class="font-bold text-base md:text-lg truncate">${movement.itemName}</h3>
                                                                <span class="text-xs px-2 py-1 ${getColorClass(typeInfo.color)} rounded-full font-semibold uppercase">${typeInfo.label}</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="md:ml-13 space-y-1 text-xs md:text-sm text-slate-400">
                                                            ${movement.employee ? `
                                                                <p class="flex items-center gap-2 truncate">
                                                                    <i class="ph ph-user flex-shrink-0"></i>
                                                                    <span class="font-semibold">Colaborador:</span> ${movement.employee}
                                                                </p>
                                                            ` : ''}
                                                            ${movement.supplier ? `
                                                                <p class="flex items-center gap-2 truncate">
                                                                    <i class="ph ph-truck flex-shrink-0"></i>
                                                                    <span class="font-semibold">Fornecedor:</span> ${movement.supplier}
                                                                </p>
                                                            ` : ''}
                                                            <p class="flex items-center gap-2">
                                                                <i class="ph ph-calendar flex-shrink-0"></i>
                                                                ${formatDate(movement.date)}
                                                            </p>
                                                            <p class="flex items-center gap-2 truncate">
                                                                <i class="ph ph-user-circle flex-shrink-0"></i>
                                                                ${movement.user}
                                                            </p>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="text-right flex-shrink-0">
                                                        <p class="text-2xl md:text-3xl font-bold font-mono ${typeInfo.sign === '+' ? 'text-emerald-400' : 'text-red-400'}">
                                                            ${typeInfo.sign}${movement.quantity}
                                                        </p>
                                                        <p class="text-xs text-slate-500 mt-1">${formatDateTime(movement.timestamp)}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>

                                <!-- Paginação -->
                                ${totalPages > 1 ? `
                                    <div class="flex justify-center items-center gap-2 mt-6 pt-6 border-t border-slate-700 flex-wrap">
                                        <button 
                                            onclick="changePage(-1)"
                                            ${state.currentPage === 1 ? 'disabled' : ''}
                                            class="px-3 md:px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed transition-all text-sm"
                                        >
                                            <i class="ph ph-caret-left"></i>
                                            <span class="hidden md:inline ml-1">Anterior</span>
                                        </button>
                                        
                                        <div class="flex gap-2">
                                            ${Array.from({length: Math.min(totalPages, 5)}, (_, i) => {
                                                let pageNum;
                                                if (totalPages <= 5) {
                                                    pageNum = i + 1;
                                                } else if (state.currentPage <= 3) {
                                                    pageNum = i + 1;
                                                } else if (state.currentPage >= totalPages - 2) {
                                                    pageNum = totalPages - 4 + i;
                                                } else {
                                                    pageNum = state.currentPage - 2 + i;
                                                }
                                                return `
                                                    <button 
                                                        onclick="state.currentPage = ${pageNum}; render()"
                                                        class="w-8 h-8 md:w-10 md:h-10 rounded-lg font-bold text-sm ${state.currentPage === pageNum ? 'bg-blue-600' : 'bg-slate-700 hover:bg-slate-600'} transition-all"
                                                    >
                                                        ${pageNum}
                                                    </button>
                                                `;
                                            }).join('')}
                                        </div>
                                        
                                        <button 
                                            onclick="changePage(1)"
                                            ${state.currentPage === totalPages ? 'disabled' : ''}
                                            class="px-3 md:px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed transition-all text-sm"
                                        >
                                            <span class="hidden md:inline mr-1">Próxima</span>
                                            <i class="ph ph-caret-right"></i>
                                        </button>
                                    </div>
                                ` : ''}
                            `}
                        </div>
                    </main>
                </div>
            `;
        }

        function renderEditItem() {
            const item = state.editingItem || {};
            const isEdit = !!state.editingItem;

            return `
                <div class="min-h-screen pb-6">
                    ${renderHeader()}
                    
                    <main class="p-4 max-w-3xl mx-auto">
                        <div class="glass p-6 md:p-8 rounded-xl">
                            <div class="flex items-center justify-between mb-6">
                                <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                                    <i class="ph-fill ph-${isEdit ? 'pencil-simple' : 'plus-circle'} text-amber-400"></i>
                                    <span class="hidden md:inline">${isEdit ? 'Editar Item' : 'Novo Item'}</span>
                                    <span class="md:hidden">${isEdit ? 'Editar' : 'Novo'}</span>
                                </h1>
                                <button onclick="goBack()" class="text-slate-400 hover:text-white transition-all">
                                    <i class="ph ph-x text-3xl"></i>
                                </button>
                            </div>

                            <form onsubmit="handleSaveItem(event)" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="md:col-span-2">
                                        <label class="text-sm font-bold text-slate-300 block mb-3 uppercase tracking-wide">Nome do Item *</label>
                                        <input 
                                            type="text"
                                            id="itemName"
                                            value="${item.nome || ''}"
                                            class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 focus:border-amber-500 outline-none text-base md:text-lg text-white"
                                            placeholder="Ex: Capacete de Segurança"
                                            required
                                        >
                                    </div>

                                    <div>
                                        <label class="text-sm font-bold text-slate-300 block mb-3 uppercase tracking-wide">Categoria *</label>
                                        <select 
                                            id="itemCategory"
                                            class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 focus:border-amber-500 outline-none text-base md:text-lg text-white"
                                            required
                                        >
                                            <option value="">Selecione...</option>
                                            <option value="Proteção Individual" ${item.categoria === 'Proteção Individual' ? 'selected' : ''}>Proteção Individual</option>
                                            <option value="Ferramentas" ${item.categoria === 'Ferramentas' ? 'selected' : ''}>Ferramentas</option>
                                            <option value="Uniformes" ${item.categoria === 'Uniformes' ? 'selected' : ''}>Uniformes</option>
                                            <option value="Outros" ${item.categoria === 'Outros' ? 'selected' : ''}>Outros</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="text-sm font-bold text-slate-300 block mb-3 uppercase tracking-wide">Unidade *</label>
                                        <select 
                                            id="itemUnit"
                                            class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 focus:border-amber-500 outline-none text-base md:text-lg text-white"
                                            required
                                        >
                                            <option value="">Selecione...</option>
                                            <option value="UN" ${item.unidade === 'UN' ? 'selected' : ''}>Unidade (UN)</option>
                                            <option value="PAR" ${item.unidade === 'PAR' ? 'selected' : ''}>Par (PAR)</option>
                                            <option value="CX" ${item.unidade === 'CX' ? 'selected' : ''}>Caixa (CX)</option>
                                            <option value="KG" ${item.unidade === 'KG' ? 'selected' : ''}>Quilograma (KG)</option>
                                            <option value="LT" ${item.unidade === 'LT' ? 'selected' : ''}>Litro (LT)</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="text-sm font-bold text-slate-300 block mb-3 uppercase tracking-wide">Quantidade *</label>
                                        <input 
                                            type="number"
                                            id="itemQuantity"
                                            value="${item.quantidade || 0}"
                                            min="0"
                                            class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 focus:border-amber-500 outline-none text-base md:text-lg text-white font-mono"
                                            required
                                        >
                                    </div>

                                    <div>
                                        <label class="text-sm font-bold text-slate-300 block mb-3 uppercase tracking-wide">CA</label>
                                        <input 
                                            type="text"
                                            id="itemCA"
                                            value="${item.ca || ''}"
                                            class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 focus:border-amber-500 outline-none text-base md:text-lg text-white font-mono"
                                            placeholder="Ex: 12345"
                                        >
                                    </div>

                                    <div>
                                        <label class="text-sm font-bold text-slate-300 block mb-3 uppercase tracking-wide">Validade</label>
                                        <input 
                                            type="date"
                                            id="itemValidity"
                                            value="${item.validade || ''}"
                                            class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 focus:border-amber-500 outline-none text-base md:text-lg text-white"
                                        >
                                    </div>

                                    <div>
                                        <label class="text-sm font-bold text-slate-300 block mb-3 uppercase tracking-wide">Localização</label>
                                        <input 
                                            type="text"
                                            id="itemLocation"
                                            value="${item.localizacao || ''}"
                                            class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 focus:border-amber-500 outline-none text-base md:text-lg text-white"
                                            placeholder="Ex: Prateleira A1"
                                        >
                                    </div>

                                    <div class="md:col-span-2">
                                        <label class="text-sm font-bold text-slate-300 block mb-3 uppercase tracking-wide">Observações</label>
                                        <textarea 
                                            id="itemObs"
                                            class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-lg p-4 focus:border-amber-500 outline-none text-base md:text-lg text-white"
                                            rows="3"
                                            placeholder="Informações adicionais..."
                                        >${item.observacoes || ''}</textarea>
                                    </div>
                                </div>

                                <div class="flex gap-4 pt-6 border-t border-slate-700">
                                    <button 
                                        type="button"
                                        onclick="goBack()"
                                        class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 rounded-xl transition-all"
                                    >
                                        CANCELAR
                                    </button>
                                    <button 
                                        type="submit"
                                        class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-bold py-4 rounded-xl transition-all flex items-center justify-center gap-2"
                                    >
                                        <i class="ph ph-floppy-disk text-xl"></i>
                                        ${isEdit ? 'ATUALIZAR' : 'CADASTRAR'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </main>
                </div>
            `;
        }

        function renderHeader() {
            return `
                <header class="bg-slate-900 border-b border-slate-800 p-3 md:p-4 sticky top-0 z-30 shadow-lg">
                    <div class="max-w-7xl mx-auto flex justify-between items-center">
                        <div class="flex items-center gap-3 md:gap-4">
                            <div class="w-10 h-10 md:w-12 md:h-12 bg-emerald-500/20 rounded-lg flex items-center justify-center">
                                <i class="ph-fill ph-package text-emerald-400 text-xl md:text-2xl"></i>
                            </div>
                            <div>
                                <h1 class="font-bold text-base md:text-xl font-mono">ALMOXARIFADO</h1>
                                <p class="text-xs md:text-sm text-slate-400 truncate max-w-[120px] md:max-w-none">${state.user?.nome || 'Sistema'}</p>
                            </div>
                        </div>
                        
                        <nav class="flex gap-1 md:gap-2">
                            <button 
                                onclick="navigateTo('dashboard')"
                                class="px-3 md:px-4 py-2 rounded-lg hover:bg-slate-800 transition-all ${state.view === 'dashboard' ? 'bg-slate-800' : ''}"
                                title="Dashboard"
                            >
                                <i class="ph-fill ph-house text-lg md:text-xl"></i>
                            </button>
                            <button 
                                onclick="navigateTo('stock')"
                                class="px-3 md:px-4 py-2 rounded-lg hover:bg-slate-800 transition-all ${state.view === 'stock' ? 'bg-slate-800' : ''}"
                                title="Estoque"
                            >
                                <i class="ph-fill ph-warehouse text-lg md:text-xl"></i>
                            </button>
                            <button 
                                onclick="navigateToHistory()"
                                class="px-3 md:px-4 py-2 rounded-lg hover:bg-slate-800 transition-all ${state.view === 'history' ? 'bg-slate-800' : ''}"
                                title="Histórico"
                            >
                                <i class="ph-fill ph-clock-counter-clockwise text-lg md:text-xl"></i>
                            </button>
                            <button 
                                onclick="handleLogout()"
                                class="px-3 md:px-4 py-2 rounded-lg hover:bg-red-900/50 transition-all text-red-400"
                                title="Sair"
                            >
                                <i class="ph-fill ph-sign-out text-lg md:text-xl"></i>
                            </button>
                        </nav>
                    </div>
                </header>
            `;
        }

        // ============================================
        // INICIALIZAÇÃO
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Tenta carregar sessão salva
            const savedUser = loadSession();
            
            if (savedUser) {
                state.user = savedUser;
                state.loadingMessage = 'Carregando...';
                state.isLoading = true;
                render();
                
                loadItems().then(() => {
                    navigateTo('dashboard');
                    state.isLoading = false;
                    state.loadingMessage = '';
                    render();
                });
            } else {
                render();
            }
        });
    </script>
</body>
</html>
